---
title: "Rails のビューヘルパのスコープと include_all_helpers オプションについて"
emoji: "🐫"
type: "tech" # tech: 技術記事 / idea: アイデア
topics:
  - "rails"
  - "ruby"
published: false
---

# デフォルトのビューヘルパのスコープについて

この記事では Rails のビューヘルパで定義されたメソッドがどの範囲をスコープとしているか、
そしてこのスコープを変更する方法、および既存からのスコープ変更の合理的な方法を説明しています。

# ヘルパに定義したメソッドはどのビューからでも呼び出せる

例えば、以下のように `UsersHelper#display_name` があったとして

```ruby:app/helpers/users_helper.rb
module UsersHelper
  def display_name(user)
    "#{user.lastname} #{user.firstname}"
  end
end
```

これは、 `UsersController` が描画するののビのーの中に限らず、別のコントローラが描画するビューの中でも使うことができます。

```ruby:app/controllers/posts_controller.rb
class PostsController
  def index
    @posts = Post.all
  end
end
```
```erb:app/views/posts/index.html.erb
<% @posts.each do |post| %>
  <p><%= post.content %></p>
  <small><%= display_name(post.user) %></small> <!-- display_name が使える -->
<% end %>
```

つまり、ビューヘルパで定義したメソッドは基本的にどのビューでも使えるということになります。

このビューヘルパの挙動ですが、そういうものなのでしょうと割り切ることもできますがかなり適用範囲が広いことによる懸念はあります。
ぱっと考えると以下あたりは気になるところです。

* そのメソッドが未使用であることを確認するためにはアプリケーション全体を調べる必要がある
* 別々のビューヘルパで同名のメソッドが定義された場合の動きの把握が困難

そういった懸念に対する回避方法として、 Rails ではオプションが提供されています。

# config.action_controller.include_all_helpers オプション

上記のとおり、 Rails の controller は、デフォルトですべての helper を読み込みますが、これは、 `config.action_controller.include_all_helpers` の設定値によるものです。

https://railsguides.jp/configuring.html#config-action-controller-include-all-helpers

> すべてのビューヘルパーをあらゆる場所で使えるようにするか、対応するコントローラのスコープ内に限定するかを設定します。

デフォルトではこの値は `true` です。

というわけで、この値を `config/application.rb` あたりで設定すると挙動がかわります。

```diff ruby:config/application.rb
 module Example
   class Application < Rails::Application
     # Initialize configuration defaults for originally generated Rails version.
     config.load_defaults 8.0
+
+   config.action_controller.include_all_helpers = false
```

そうすると、例えば以下のように `UsersHelper` で定義されているメソッド `display_name` を、
`PostsController` が描画するビューでは呼び出せなくなります。

```ruby:app/helpers/users_helper.rb
module UsersHelper
  def display_name(user)
    "#{user.lastname} #{user.firstname}"
  end
end
```

```ruby:app/controllers/posts_controller.rb
class PostsController
  def index
    @posts = Post.all
  end
end
```
```erb:app/views/posts/index.html.erb
<% @posts.each do |post| %>
  <p><%= post.content %></p>
  <!-- 呼び出せない！ -->
  <small><%= display_name(post.user) %></small> <!-- undefined method 'display_name' for ... -->
<% end %>
```

## 適用されるヘルパはどうやって決定されるのか?

例えばい以下のようなコントローラおよびビューヘルパの継承関係があったとして説明しますと

```
app/
├── controllers
│   ├── admin
│   │   ├── application_controller.rb
│   │   └── users_controller.rb
│   ├── application_controller.rb
│   ├── posts_controller.rb
│   └── users_controller.rb
└── helpers
    ├── admin
    │   ├── application_helper.rb
    │   └── users_helper.rb
    ├── application_helper.rb
    ├── posts_helper.rb
    └── users_helper.rb
```

```ruby:app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
end
```
```ruby:app/controllers/users_controller.rb
class UsersController < ApplicationController
end
```
```ruby:app/controllers/posts_controller.rb
class PostsController < ApplicationController
end
```
```ruby:app/controllers/admin/application_controller.rb
class Admin::ApplicationController < ApplicationController
end
```
```ruby:app/controllers/admin/users_controller.rb
class Admin::UsersController < Admin::ApplicationController
end
```

`UsersController` のコンテクストで適用される helper は以下のようになります。

1. `UsersHelper`
2. `ApplicationHelper`

これは、コントローラでの継承関係に依存しています。
`UsersHelper` は `ApplicationHelper` を継承しているので `users`, `application` という順番でたどるわけです。

もう一例出しますと、 `Admin::UsersController` のコンテクストでは適用される helper は以下のようになります。

1. `Admin::UsersHelper`
2. `Admin::ApplicationHelper`
3. `ApplicationHelper`

これも、継承関係と照らし合わせるとわかります。
`admin/users`, `admin/application` そして `application` という順番でたどります。

この挙動は、テンプレートやパーシャルを描画する際の探索パスの仕組みである**テンプレートの継承と同じ**形です。
https://railsguides.jp/layouts_and_rendering.html#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%AE%E7%B6%99%E6%89%BF

# 既存アプリケーションで include_all_helpers を false にしたい

なるほどこれは非常に有用だな！というわけで既存のアプリケーションで `config.action_controller.include_all_helpers` を `false` にする場合のマイグレーションパスをたどってみます。

## はじめの一歩

はじめにやることは、もちろん `config.action_controller.include_all_helpers` 設定値を `false` にすることです。

```diff ruby:config/application.rb
 module Example
   class Application < Rails::Application
     # Initialize configuration defaults for originally generated Rails version.
     config.load_defaults 8.0
+
+   config.action_controller.include_all_helpers = false
```

ただ、単純にこれを設定しただけだと当然、ビュー描画時にスコープ外となってしまったビューヘルパのメソッド呼び出しに失敗してしまいます。
それを回避するために、 **`ApplicationHelper` ですべてのビューヘルパをインクルード**します。これが第一歩です。

```ruby:app/helpers/application_helper.rb
module ApplicationHelper
  include Admin::ApplicationHelper
  include Admin::UsersHelper
  include PostsHelper
  include UsersHelper
end
```

通常、多くのアプリケーションでは、すべてのコントローラはスーパークラスをたどると最終的に `ApplicationController` に到達するはずです。
その前提の場合 `ApplicationHelper` はすべてのビュー描画で適用可能なビューヘルパということになります。

## 段階的によりわける

あとは、段階的にこのインクルードしている関係を疎にしていきます。
たとえば `Admin::*` 配下のコントローラは必ず `Admin::ApplicationController` を継承していることがはっきりしているなら、以下のようにもできますね。

```ruby:app/helpers/application_helper.rb
module ApplicationHelper
  include Admin::ApplicationHelper
  include PostsHelper
  include UsersHelper
end
```
```ruby:app/helpers/admin/application_helper.rb
module Admin::ApplicationHelper
  include Admin::UsersHelper
end
```

最終的にはビューヘルパ同士のインクルードをやめることができれば良いと思います。
例えば `PostsHelper` で定義されたメソッド定義が `PostsController` 以外で使われてないとはっきりしたらインクルードを削除したり

```diff ruby:app/helpers/application_helper.rb
 module ApplicationHelper
   include Admin::ApplicationHelper
-  include PostsHelper
   include UsersHelper
 end
```

逆に、いろんなコンテクストで使われているビューヘルパのメソッドを、 `ApplicationHelper` の方に引っ越ししてきたりです。

```diff ruby:app/helpers/application_helper.rb
 module ApplicationHelper
   include Admin::ApplicationHelper
-  include UsersHelper
+
+  def very_useful_helper_method(user)
+    #
+  end
 end
```
```diff ruby:app/helpers/users_helper.rb
 module UsersHelper
-  def very_useful_helper_method(user)
-    #
-  end
 end
```

# 免責事項など

この記事では Rails のビューヘルパで定義されたメソッドがどのあたりをスコープとしているかを説明しています。
以下は Rails 8.0.2.1 で確認していますが基本的に過去の多くのバージョンでは同様です。 ^[正確には `include_all_helpers` が導入された Rails 3.1 以降を前提にしています] ^[将来 `include_all_helpers` のデフォルト値が `false` となった場合は記事内容が少々不整合となるかもしれません]
