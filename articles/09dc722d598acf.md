---
title: "Ruby の block-pass に Symbol を渡すのはもう避けたいかもしれません"
emoji: "🐫"
type: "tech" # tech: 技術記事 / idea: アイデア
topics:
  - "ruby"
published: false
---

この記事では、 Ruby のブロックパラメータの軽い歴史とトレンド、
そして自分のこれに対する思いを書いたものです。

# ブロックパラメータの歴史

最近 Ruby では `it` というブロックパラメータが追加されました。

```ruby
# 以下はいずれも、 ["1", "2", "3"] という結果を返します。

# 一番プリミティブな書き方
[1, 2, 3].map { |i| i.to_s }

# Ruby 1.9 からできるようになった書き方
[1, 2, 3].map(&:to_s)

# Ruby 2.7 から、 Numbered Parameters が追加されました
[1, 2, 3].map { _1.to_s }

# Ruby 3.4 から、 it が追加されました
[1, 2, 3].map { it.to_s }
```

## プリミティブな記述について

まず、以下のようなプリミティブな書き方ですが、 `i` という変数が使われています。
このようなごく小さなブロックにおいて、名前自体がなんでもよいのですがどうしてもそこに名前をつける必要がありました。

```ruby
# 一番プリミティブな書き方
[1, 2, 3].map { |i| i.to_s }
```

## `Symbol#to_proc` な記述について

そして、 block-pass に Symbol を渡すことで `Symbol#to_proc` が呼ばれることを前提とした以下のコードが使われるようになりました。

```ruby
# Ruby 1.9 からできるようになった書き方
[1, 2, 3].map(&:to_s)
```

ちなみに、 `Symbol#to_proc` は以下のように
「引数をひとつ受け取り、そこに `send` する」というような挙動をします。^[厳密にこの挙動なのかは調べてないですが少なくともこの理解で困ることはありません]

```ruby
sym = :to_s
blk = sym.to_proc

# ->(obj) { obj.send(:to_s) } みたいな挙動
blk.call(1)  #=> "1"
```

この Symbol を、 block-pass として渡すことで暗黙的に `to_proc` が呼ばれるので先に期待した挙動となっているわけです。

## Numbered Parameters と `it`

それから時は流れ、「名前はなんでもよい (名前がないことに意味がある)」がより明確に表現された Numbered Parameters と `it` が誕生しました。

```ruby
# Ruby 2.7 から、 Numbered Parameters が追加されました
[1, 2, 3].map { _1.to_s }

# Ruby 3.4 から、 it が追加されました
[1, 2, 3].map { it.to_s }
```

# 主張というか思いについて

このように進化してきたわけですが、動機としては「名前はなんでもよい (名前がないことに意味がある)」がポイントになっていると思います。
その点については、たしかに Ruby 1.9 以降の記法はそれに対する解決になっています。

そのうえでの思いですが、**私は `it` 推し**です。
より突っ込むと、 `_1` でも `it` でもよいと思っているのですが「それ」と表せる `it` は `_1` との 2択であれば `it` かなと思っています。

`Symbol#to_proc` は短く書けるのですが、**「否 Ruby 話者が見ると何をやっているか悩む」**という点が見逃せない課題だと思っていました。
Ruby は同じ課題を解決するのに色んな記述ができて楽しいのですが、私は Ruby が流行ってほしいので初心者にとってのとっつきやすさは重要なファクタだと思っています。

また、内部での話とはいえ `send` (相当?) が動くのもあまり健全ではないと感じますし、 `_1` や `it` は IDE との相性もよさそうです。

そんなわけで、もう **`Symbol#to_proc` を捨てて、コードゴルフ専用記述扱い ^[`?a` の String Literal みたいな]にするのがよいのでは?** と思っています。

# Custom Cop

主張するだけならポエムなので、この主張を助ける Custom Cop を用意します。
Rubocop の custom cop として以下を適用すると、 `array.map(&:to_s)` のような記述を違反としてくれます。

[Style::SymbolProc](https://www.rubydoc.info/gems/rubocop/RuboCop/Cop/Style/SymbolProc) の逆みたいなものです。

```ruby
# at .rubocop.yml
#
# Custom/AvoidSymbolBlockPass:
#   Enabled: true
#

# NG
# array.map(&:to_s)
# users.each(&:destroy)
#
# # OK
# array.map { it.to_s }
# users.each { it.destroy }
#
class RuboCop::Cop::Custom::AvoidSymbolBlockPass < RuboCop::Cop::Base
  MSG = "Symbol#to_proc (`&:to_s`) の使用を避け、代わりに `it` などの使用を検討してください。"

  def on_block_pass(node)
    return unless node.children.first&.sym_type?

    add_offense(node)
  end
end
```

# まとめ

* Ruby の block parameter の書き方はいくつかあります、その歴史を簡単に説明しました。
* `array.map(&:to_s)` のような `Symbol#to_proc` に依存する記述を、未来の初心者が読むときのために避けたい気持ちがあります
* そのために、ちょっとした Custom Cop を共有しました。

