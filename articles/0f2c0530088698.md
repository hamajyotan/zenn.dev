---
title: "RSpec ã§ seed å›ºå®šã—ã¦ flaky test ã‚’ã‚„ã£ã¤ã‘ã¾ã—ã‚‡ã†"
emoji: "ğŸ«"
type: "tech"
topics:
  - "rails"
  - "ruby"
published: false
---

# ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

RSpec ã§æ›¸ã„ãŸãƒ†ã‚¹ãƒˆã‚’ CI ã§å®Ÿè¡Œã™ã‚‹éš›ã€ã¨ãã©ãå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒã‚ã£ãŸã‚Šã—ãªã„ã§ã—ã‚‡ã†ã‹? ã„ã‚ã‚†ã‚‹ flaky test ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚
ã“ã‚Œã«ä½•ã‚‚è€ƒãˆãšã« re-run ã«ã‚ˆã‚ŠæˆåŠŸã‚’è¦³æ¸¬ã—ã¦ï¾–ï½¼ï½¯! ã¿ãŸã„ãªé‹ç”¨ã—ã¦ã„ã‚‹ã®ã¯ã‚‚ã£ãŸã„ãªã„ã®ã§ç›´ã—ã¾ã—ã‚‡ã†ã¨ã„ã†å†…å®¹ã§ã™ã€‚

## `config.order` ã‚ˆã³ `Kernel.srand` ã®è¨­å®š

ã¨ã„ã£ã¦ã‚‚å¤§ã—ãŸã“ã¨ã§ãªãã€ RSpec ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä»¥ä¸‹ã®ç®‡æ‰€ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ã‚‡ã†ã¨ã„ã†è©±ã§ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

```ruby:spec/spec_helper.rb
  # Run specs in random order to surface order dependencies. If you find an
  # order dependency and want to debug it, you can fix the order by providing
  # the seed, which is printed after each run.
  #     --seed 1234
  config.order = :random

  # Seed global randomization in this process using the `--seed` CLI option.
  # Setting this allows you to use `--seed` to deterministically reproduce
  # test failures related to randomization by passing the same `--seed` value
  # as the one that triggered the failure.
  Kernel.srand config.seed
=end
```

ã“ã®è¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ãŠãã¨ã€ãƒ©ãƒ³ãƒ€ãƒ ã«å¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ã‚ã¨ã‹ã‚‰å†ç¾ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»¥ä¸‹ã¯æ—¥æœ¬èªã§ã‚³ãƒ¡ãƒ³ãƒˆã®ç®‡æ‰€ã‚’è¨³ã—ãŸã‚‚ã®ã§ã™ã€‚

> é †åºã®ä¾å­˜é–¢ä¿‚ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ãŸã‚ã«ã€ã‚¹ãƒšãƒƒã‚¯ï¼ˆãƒ†ã‚¹ãƒˆï¼‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªé †åºã§å®Ÿè¡Œã—ã¾ã™ã€‚
> ã‚‚ã—é †åºã®ä¾å­˜é–¢ä¿‚ãŒè¦‹ã¤ã‹ã‚Šã€ãƒ‡ãƒãƒƒã‚°ã—ãŸã„å ´åˆã¯ã€å„å®Ÿè¡Œå¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚·ãƒ¼ãƒ‰å€¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€é †åºã‚’å›ºå®šã§ãã¾ã™ã€‚
>   â€ƒâ€ƒ--seed 1234

> ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ©ãƒ³ãƒ€ãƒ åŒ–ã‚’è¡Œã†ã«ã¯ã€`--seed` ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
> ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã®å¤±æ•—ã‚’å†ç¾ã™ã‚‹éš›ã«ã€å¤±æ•—ã‚’å¼•ãèµ·ã“ã—ãŸã‚‚ã®ã¨åŒã˜ `--seed` ã®å€¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€æ±ºå®šè«–çš„ã«å†ç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¡ãªã¿ã« generate ã—ãŸç›´å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ã§ã¯ `=begin` ã‹ã‚‰ `=end` ã¾ã§ã®é–“ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚
ã¤ã¾ã‚Šã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æœ‰åŠ¹åŒ–ã™ã‚‹å ´åˆã¯ã“ã‚Œã‚‰ã®å¤–ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚

https://github.com/rspec/rspec-core/blob/v3.13.2/lib/rspec/core/project_initializer/spec/spec_helper.rb#L86-L97

```ruby
=begin
  ã“ã“ã¯
  # å…¨éƒ¨ã‚³ãƒ¡ãƒ³ãƒˆ
  ã§ã™
=end
```

# flaky test å¯¾å¿œã®å®Ÿè·µ

ä»¥ä¸‹ã§ã¯ã€è©¦ã—ã«ã©ã‚“ãªæµã‚Œã§ flaky test ãŒå¯¾å¿œã•ã‚Œã‚‹ã‹ã‚’å®Ÿè·µã—ã¦ã„ã¾ã™ã€‚

## rails new ã‹ã‚‰ã®æº–å‚™

```console
# rails ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
$ rails new --skip-test rspec-rails-test
$ cd rspec-rails-test/

# rspec-rails ã®å°å…¥ãŠã‚ˆã³åˆæœŸè¨­å®š
$ bundle add rspec-rails --group development,test
$ rails generate rspec:install
```

ç¶šã„ã¦ã€ä¾‹ã® `config.order` ã‚ˆã³ `Kernel.srand` ã«é–¢ã™ã‚‹è¨­å®šã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
`=begin` `=end` ã®é–“ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’å¤–ã«å‡ºã™å½¢ã«èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚

```diff:spec/spec_helper.rb
   # Print the 10 slowest examples and example groups at the
   # end of the spec run, to help surface which specs are running
   # particularly slow.
   config.profile_examples = 10
+=end

   # Run specs in random order to surface order dependencies. If you find an
   # order dependency and want to debug it, you can fix the order by providing
   # the seed, which is printed after each run.
   #     --seed 1234
   config.order = :random

   # Seed global randomization in this process using the `--seed` CLI option.
   # Setting this allows you to use `--seed` to deterministically reproduce
   # test failures related to randomization by passing the same `--seed` value
   # as the one that triggered the failure.
   Kernel.srand config.seed
-=end
 end
```

è©¦ã—ã«ã“ã“ã§ `bundle exec rspec` ã‚’å®Ÿè¡Œã—ã¦ã‚¼ãƒ­ä»¶ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

```console
$ bundle exec rspec
No examples found.

Randomized with seed 37597


Finished in 0.00031 seconds (files took 0.09676 seconds to load)
0 examples, 0 failures
                                                                                                                                                                                                                                                            Randomized with seed 37597

$
```

## ãƒ¢ãƒ‡ãƒ«ã‚’ä½œã£ã¦ãƒ†ã‚¹ãƒˆã‚‚è¨˜è¿°

ãƒ†ã‚¹ãƒˆã®å¯¾è±¡ã§ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ã²ã¨ã¤ä½œã£ã¦ã¿ã¾ã™ã€‚
å¹´æœˆã‚’æ„å‘³ã™ã‚‹ã€ `YearMonth` ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã€å±æ€§ã¯ `year` ã¨ `month` ã‚’æœ‰ã—ã¾ã™ã€‚
ãã‚Œãã‚Œã«ç°¡å˜ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚è¨˜è¼‰ã—ã¾ã™ã€‚
`only_integer` ã€ã¤ã¾ã‚Šæ•´æ•°ã®ã¿ã‚’è¨±å®¹ã—ã€ `month` ã®æ–¹ã«ã¯ã•ã‚‰ã« 1-12 ã®ç¯„å›²ã®ã¿ã‚’è¨±å®¹ã™ã‚‹å½¢ã«æ§‹æˆã—ã¾ã™ã€‚

```ruby:app/models/year_month.rb
class YearMonth
  include ActiveModel::Model
  include ActiveModel::Attributes

  attribute :year, :integer
  attribute :month, :integer

  validates :year, numericality: { only_integer: true }
  validates :month, numericality: { only_integer: true, in: (1..12) }
end
```

ã¤ã¥ã„ã¦ `YearMonth` ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚
ã¨ã„ã£ã¦ã‚‚ã€ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ãŒ `valid?` ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã ã‘ã®ç°¡å˜ãªã‚‚ã®ã§ã™ã€‚

```ruby:spec/models/year_month_spec.rb
require "rails_helper"

RSpec.describe YearMonth do
  subject { YearMonth.new(attributes) }

  let(:attributes) { { year:, month: } }
  let(:year) { rand(2100) }
  let(:month) { rand(12) }

  it do
    expect(subject.valid?).to be_truthy
  end
end
```

## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ

ãã—ã¦ `bundle exec rspec` ã§ãƒ†ã‚¹ãƒˆãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```console
$ bundle exec rspec

Randomized with seed 54242
.

Finished in 0.0191 seconds (files took 0.92096 seconds to load)
1 example, 0 failures

Randomized with seed 54242

$
```

:::message
ã“ã“ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå¤±æ•—ãŒç”Ÿã˜ãŸã‚¢ãƒ³ãƒ©ãƒƒã‚­ãƒ¼ãªæ–¹ã¯ã€è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ã‚‚ã†ã„ã¡ã©ãƒ†ã‚¹ãƒˆã‚’æµã—æˆåŠŸã¨ãªã‚‹ã®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
$ bundle exec rspec

Randomized with seed 30925
F

Failures:

  1) YearMonth is expected to be truthy
     Failure/Error: expect(subject.valid?).to be_truthy

       expected: truthy value
            got: false
     # ./spec/models/year_month_spec.rb:11:in 'block (2 levels) in <top (required)>'

Finished in 0.01313 seconds (files took 0.50544 seconds to load)
1 example, 1 failure

Failed examples:

rspec ./spec/models/year_month_spec.rb:10 # YearMonth is expected to be truthy

Randomized with seed 30925

$
```
:::

## ãŸã¾ã«å¤±æ•—ã™ã‚‹ã®ã‚’è¦³æ¸¬ã™ã‚‹

å®Ÿã¯ã“ã®ãƒ†ã‚¹ãƒˆã¯ã¨ãã©ãå¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ä½•å›ã‹å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç•°å¸¸çµ‚äº†ãŒç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã§ã€å…ƒæ°—ã«æ­£å¸¸çµ‚äº†ã—ã¦ã„ã‚‹ CI ãŒæ™‚ã€…å¤±æ•—ã‚’é€šçŸ¥ã—ã¦ãã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã­ã€‚

```
$ bundle exec rspec

Randomized with seed 30925
F

Failures:

  1) YearMonth is expected to be truthy
     Failure/Error: expect(subject.valid?).to be_truthy

       expected: truthy value
            got: false
     # ./spec/models/year_month_spec.rb:11:in 'block (2 levels) in <top (required)>'

Finished in 0.01313 seconds (files took 0.50544 seconds to load)
1 example, 1 failure

Failed examples:

rspec ./spec/models/year_month_spec.rb:10 # YearMonth is expected to be truthy

Randomized with seed 30925

$
```

:::message
å®Ÿéš›ã®æ¥­å‹™ãªã©ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€
å¤±æ•—ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—ç¶šã‘ã‚‹ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã‚Šã“ã‚Œã‚’å®Ÿè¡Œã—ã¦é£Ÿäº‹ã‚’ã—ãŸã‚Šä»•äº‹ã‚’çµ‚ãˆã¦ç¿Œæ—¥ã¾ã§æ”¾ç½®ãªã©ãŒã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚

```bash:test-loop.sh
#!/bin/bash
set -euxo pipefail

i=0
while true
do
  i=`expr $i + 1`
  bundle exec rspec
done
```
:::


## å¤±æ•—ã‚’å†ç¾ã™ã‚‹

å¤±æ•—ã—ãŸã¨ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ç®‡æ‰€ã«æ³¨ç›®ã—ã¾ã™ã€‚

```
Randomized with seed 30925
```

ã“ã®ã€ã‚·ãƒ¼ãƒ‰å€¤ (ä»Šå›ã®å ´åˆ) `30925` ãŒãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚
ã“ã®å€¤ã‚’ã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ `--seed` ã«æŒ‡å®šã—ã¦å®Ÿè¡Œã™ã‚‹ã¨å…ˆç¨‹ã®ä¹±æ•°ã®çµæœãŒå†ç¾ã§ãã‚‹ãŸã‚ç¢ºå®Ÿã«å†ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```console
$ bundle exec rspec --seed 30925

Randomized with seed 30925
F

Failures:

  1) YearMonth is expected to be truthy
     Failure/Error: expect(subject.valid?).to be_truthy

       expected: truthy value
            got: false
     # ./spec/models/year_month_spec.rb:11:in 'block (2 levels) in <top (required)>'

Finished in 0.02331 seconds (files took 0.90374 seconds to load)
1 example, 1 failure

Failed examples:

rspec ./spec/models/year_month_spec.rb:10 # YearMonth is expected to be truthy

Randomized with seed 30925

$
```

## ãƒ‡ãƒãƒƒã‚°ã«ã‚ˆã‚‹åŸå› ç‰¹å®š

å†ç¾ã•ãˆã§ãã‚Œã°ã€ã‚ã¨ã¯ç´ ç›´ã«ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã ã‘ã§ã™ã€‚
ã“ã“ã§ã¯æ„šç›´ã« `puts` ã‚’å…¥ã‚Œã¦ `attributes` ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚

```diff:spec/models/year_month_spec.rb
 require "rails_helper"

 RSpec.describe YearMonth do
   subject { YearMonth.new(attributes) }

   let(:attributes) { { year:, month: } }
   let(:year) { rand(2100) }
   let(:month) { rand(12) }

   it do
+    puts "attributes: #{subject.attributes.inspect}"
     expect(subject.valid?).to be_truthy
   end
 end
```
```console
$ bundle exec rspec --seed 30925

Randomized with seed 30925
attributes: {"year" => 1913, "month" => 0}
F

Failures:

  1) YearMonth is expected to be truthy
     Failure/Error: expect(subject.valid?).to be_truthy

       expected: truthy value
            got: false
     # ./spec/models/year_month_spec.rb:12:in 'block (2 levels) in <top (required)>'

Finished in 0.01298 seconds (files took 0.50863 seconds to load)
1 example, 1 failure

Failed examples:

rspec ./spec/models/year_month_spec.rb:10 # YearMonth is expected to be truthy

Randomized with seed 30925

$
```

`month` ã®å€¤ãŒ `0` (ã‚¼ãƒ­) ã§ã™ã­ã€‚

```
attributes: {"year" => 1913, "month" => 0}
```

`rannd(12)` ã®ç®‡æ‰€ãŒé–“é•ã£ã¦ã„ã¾ã—ãŸã€‚
ã“ã®å ´åˆã€ 0 ã‹ã‚‰ 11 ã¾ã§ã®ç¯„å›²ã®ä¹±æ•°ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚

```ruby
  let(:month) { rand(12) }
```
```ruby
> 10000.times.map { rand(12) }.uniq.sort
=> [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
```

## ã‚ã¨ã¯ç°¡å˜ã€ç›´ã—ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†

åŸå› ã®ã—ã£ã½ã‚’æ´ã‚“ã ã®ã§ã€ã‚ã¨ã¯ï½¼ï½­ï½¯!ã¨ç›´ã—ã¦ã—ã¾ãˆã°è§£æ±ºã§ã™ï¼

```diff:spec/models/year_month_spec.rb
 require "rails_helper"

 RSpec.describe YearMonth do
   subject { YearMonth.new(attributes) }

   let(:attributes) { { year:, month: } }
   let(:year) { rand(2100) }
-  let(:month) { rand(12) }
+  let(:month) { rand(1..12) }

   it do
     expect(subject.valid?).to be_truthy
   end
 end
```
```ruby
> 10000.times.map { rand(1..12) }.uniq.sort
=> [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
```

ã‚ã¨ã¯ã‚³ãƒŸãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’ç©ã‚“ã§ CI ã«æµã™ãªã‚Šã—ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†ï¼

```console
git commit -m 'fix flaky test'
```

# ã¾ã¨ã‚

* RSpec ã§ã® `spec/spec_helper.rb` ã§ `config.order = :random` ãŠã‚ˆã³ `Kernel.srand config.seed` ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ flaky test é€€æ²»ãŒæ—ã‚Šã¾ã™ã€‚
* å¤±æ•—ã—ãŸã¨ãã®å‡ºåŠ›ã‹ã‚‰ã‚·ãƒ¼ãƒ‰å€¤ã‚’ç¢ºèªã—ã€ `--seed` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§å¤±æ•—ã‚’å†ç¾ã§ãã¾ã™
* å‰²ã‚Œçª“ã«ã›ãšã‚³ãƒ„ã‚³ãƒ„ç›´ã—ã€æœ¬å½“ã«æ•ã¾ãˆã‚‹ã¹ãå¤±æ•—ã‚’èªçŸ¥ã—ã‚„ã™ã„çŠ¶æ…‹ã‚’ä½œã‚Šã¾ã—ã‚‡ã†

