---
title: "RSpec ã§ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸã¨ãã«ã‚ˆã‚Šè©³ã—ã„æƒ…å ±ã‚’å¾—ã‚‹ã«ã¯ï¼Ÿ"
emoji: "ðŸ«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "ruby"
  - "rails"
published: false
---

RSpec ã§ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸã¨ãã€ã‚‚ã¡ã‚ã‚“ãã®åŽŸå› ã‚’æŽ¢ã‚‹ã‚ã‘ã§ã™ãŒã€ãã®ã¨ãã«ã©ã‚“ãªæ‰‹æ®µã‚’æ€ã„ã¤ãã¾ã™ã‹ï¼Ÿ
ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã‚ã‚Œã° `binding.b`ï¼ˆbyebug ã‚„ pry ãªã©ï¼‰ã§å‡¦ç†ã‚’æ­¢ã‚ã¦ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§èª¿æŸ»ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚ã§ã‚‚ã€CI ä¸Šã§ã®ã¿å†ç¾ã™ã‚‹ flaky ãªãƒ†ã‚¹ãƒˆã«é­é‡ã—ãŸã¨ãã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã“ã®è¨˜äº‹ã§ã¯ã€ãã‚“ãªã‚±ãƒ¼ã‚¹ã§ã‚‚å°‘ã—å½¹ã«ç«‹ã¤ã€Œå¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºã™ã‚‹ã€ãŸã‚ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## `expect(...).to matcher, message` ã®ç¬¬2å¼•æ•°ã£ã¦ï¼Ÿ

RSpec ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```ruby
expect(actual).to eq(expected)
```

ã“ã® `.to` ãƒ¡ã‚½ãƒƒãƒ‰ã€å®Ÿã¯ç¬¬2å¼•æ•°ã«ã€Œå¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```ruby
expect(actual).to eq(expected), "ã¡ãŒã„ã¾ã™"
```

å¤±æ•—ã—ãŸå ´åˆã€ã“ã® `"ã¡ãŒã„ã¾ã™"` ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
ã•ã‚‰ã«ä¾¿åˆ©ãªã®ã¯ã€**ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã§æ¸¡ã›ã‚‹**ã¨ã„ã†ç‚¹ã§ã™ã€‚

```ruby
expect(actual).to eq(expected), -> { "ã¡ãŒã„ã¾ã™: actual=#{actual.inspect}" }
```

ãƒ–ãƒ­ãƒƒã‚¯ã¯ **ãƒžãƒƒãƒãƒ£ãŒå¤±æ•—ã—ãŸã¨ãã®ã¿è©•ä¾¡ã•ã‚Œã‚‹** ãŸã‚ã€
å¤±æ•—æ™‚ã®çŠ¶æ…‹ã‚’ãƒ­ã‚°ã®ã‚ˆã†ã«åŸ‹ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

## CI ç’°å¢ƒã§ flaky test ã‚’æŽ¢ã‚‹ã¨ãã«ã‚‚

CI ä¸Šã§ã®ã¿å¤±æ•—ã™ã‚‹ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã¯ã€å†ç¾ãŒé›£ã—ã„ã‹ã‚‰ã“ãåŽŸå› èª¿æŸ»ãŒå¤§å¤‰ã§ã™ã€‚
ãã‚“ãªã¨ãã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Œå¤±æ•—æ™‚ã®å€¤ã‚„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã¦ãŠãã¨ã€ãƒ­ã‚°ã ã‘ã§åˆ¤æ–­ã§ãã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

```ruby
expect(result).to eq("æˆåŠŸ"), -> {
  <<~MSG
    çµæžœãŒä¸€è‡´ã—ã¾ã›ã‚“ã§ã—ãŸã€‚
    å®Ÿéš›ã®å€¤: #{result.inspect}
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: #{user.id}
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: #{params.inspect}
  MSG
}
```

ã“ã®ã‚ˆã†ã«ã—ã¦ãŠã‘ã°ã€CI ã®ãƒ­ã‚°ã‹ã‚‰ã§ã‚‚ã€Œãªã«ãŒã©ã†å¤±æ•—ã—ãŸã®ã‹ã€ã‚’è¿½ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚

## ã©ã†ã‚„ã£ã¦å‹•ã„ã¦ã„ã‚‹ã®ï¼Ÿ

ã“ã®ä»•æ§˜ã¯ RSpec ã®å†…éƒ¨ã§ã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

- `expect(...).to` ã¯ `ExpectationTarget#to` ãƒ¡ã‚½ãƒƒãƒ‰
- ç¬¬2å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚ŒãŸæ–‡å­—åˆ—ã¾ãŸã¯ Proc ã‚’å—ã‘å–ã‚‹
- ãƒžãƒƒãƒãƒ£ãŒå¤±æ•—ã—ãŸã¨ãã€`RSpec::Expectations.fail_with` ãŒãã‚Œã‚’è©•ä¾¡ã—ã€ä¾‹å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ä½¿ã†

ãƒ–ãƒ­ãƒƒã‚¯ã§æ¸¡ã—ãŸå ´åˆã‚‚ã€ã¡ã‚ƒã‚“ã¨å‘¼ã³å‡ºã•ã‚Œã¦è©•ä¾¡ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

RSpec ã® `.to` ãƒ¡ã‚½ãƒƒãƒ‰ã«ç¬¬2å¼•æ•°ã‚„ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¸¡ã™ã“ã¨ã§ã€å¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºã§ãã¾ã™ã€‚
ã“ã‚Œã¯å˜ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰ãˆã‚‹ã ã‘ã§ãªãã€ã€ŒCI ä¸Šã§ã—ã‹å†ç¾ã—ãªã„ãƒ†ã‚¹ãƒˆã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ­ã‚°ã«æ®‹ã™ã€ã¨ã„ã†è¦³ç‚¹ã§ã‚‚ã¨ã¦ã‚‚æœ‰ç”¨ã§ã™ã€‚

å†ç¾ã®é›£ã—ã„ãƒã‚°ã«å‡ºä¼šã£ãŸã¨ãã€å°‘ã—ã§ã‚‚ãã®åŽŸå› ã«è¿‘ã¥ã‘ã‚‹ã‚ˆã†ã«ã€ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## ãŠã¾ã‘: `.not_to` ã‚„ `raise_error` ã®ã¨ãã¯ï¼Ÿ

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ `.not_to` ã‚„ `expect { ... }.to raise_error` ãªã©ã€ã»ã¨ã‚“ã©ã®ãƒžãƒƒãƒãƒ£ã§ã‚‚ä½¿ãˆã¾ã™ã€‚
RSpec ã® matcher ã¯ã™ã¹ã¦ `RSpec::Expectations::Handler` ã‚’çµŒç”±ã—ã¦è©•ä¾¡ã•ã‚Œã¦ãŠã‚Šã€å¤±æ•—æ™‚ã«ã¯åŒæ§˜ã« `fail_with` ã‚’é€šã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã§ã™ã€‚
